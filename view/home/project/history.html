{% extends "./../basebar.html" %}

{% block title %}历史列表{% endblock %}

{% block headerbar %}
<link rel="stylesheet" href="/static/app/css/hwLayer.css">
<style>
    #app {
        padding-left: 30px;
        padding-right: 30px;
    }

    @media screen and (min-width: 760px) {
        .history-list {
            width: calc(40% - 3px);
            height: calc(100vh - 160px);
            display: inline-block;
            vertical-align: top;
        }

        .app-selected {
            width: calc(60% - 3px);
            display: inline-block;
            height: calc(100vh - 160px);
            overflow: auto;
            vertical-align: top;
        }
    }

    @media screen and (max-width: 760px) {
        .history-list {
            width: 100%;
            height: 50vh;
            display: inline-block;
            vertical-align: top;
        }

        .app-selected {
            width: 100%;
            display: inline-block;
            height: 50vh;
            vertical-align: top;
        }
    }

    .app-item-wrapper {
        padding-bottom: 30px;
    }

    .app-item {
        padding: 10px;
        margin: 4px auto;
        height: 35px;
        box-sizing: content-box;
        border: 1px solid lightgray;
        /*cursor: pointer;*/
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        font-weight: 400;
        background-color: #ffffff;
    }

    .app-item div span {
        font-weight: 400;
    }

    .app-item:hover {
        border: 1px solid #49a2f5 !important;
    }

    .app-item .logo {
        padding: 5px;
        height: 50px;
        width: 50px;
        float: left;
        /*position: absolute;*/
    }

    .app-item > div {
        /*padding-left: 70px;*/
        float: left;
        /*display: inline-block;*/
    }

    .app-item .detail-info {
        color: #49a2f5;
        border: 1px solid #49a2f5;
        border-radius: 2px;
        padding: 2px;
        cursor: pointer;
    }

    .app-item .detail-info:hover {
        /*border: none;*/
        background-color: #49a2f5 !important;
        color: #ffffff !important;
    }

    .history-list {
        position: relative;
    }

    .history-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: rgba(13, 21, 56, 0.16);
    }

    .app {

        overflow: auto;
        height: 100%;

        /*padding-top: 80px;*/
    }

    .app-wrapper {
        position: relative;
        min-height: 100%;
        height: auto !important;
        height: 100%;
    }

    .app span {
        font-weight: 100;
        font-size: 1.1em;
    }

    .app .pagination {
        position: absolute;
        bottom: 0;
        right: 0;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin: 0;
    }

    .app .pagination span {

        width: 25px;
        height: 25px;
        line-height: 25px;
        white-space: nowrap;
        text-align: center;
        background-color: #ffffff;
        margin: auto 2px;
        font-size: 12px;
        font-weight: 400;
        border: 1px solid lightgray;
        cursor: pointer;
    }

    .app .pagination span img {
        vertical-align: baseline;
        width: 12px;
        height: 7.5px;
    }

    .app .pagination .active {
        border: 1px solid #49a2f5;
        background-color: #49a2f5;
        color: #FFFFFF;
    }

    .list-enter-active,
    .list-leave-active {
        transition: all 1s;
    }

    .list-enter,
    .list-leave-active {
        opacity: 0;
        transform: translateY(-30px);
    }

    .bounce-enter-active {
        animation: bounce-in .5s;
    }

    .bounce-leave-active {
        animation: bounce-out .5s;
    }

    @keyframes bounce-in {
        0% {
            transform: scale(0);
        }
        50% {
            transform: scale(1.5);
        }
        100% {
            transform: scale(1);
        }
    }

    @keyframes bounce-out {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.5);
        }
        100% {
            transform: scale(0);
        }
    }

    .empty-page {
        text-align: center;
        float: left;
        margin-top: 50%;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        font-weight: 400;
    }

    .app-selected {
        padding-left: 50px;
        /*padding-right: 50px;*/
    }

    .app-info-detail {
    }

    .app-info-detail .logo {
        width: 64px;
        height: 64px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .app-info-detail .app-name {
        padding: 10px;
        border: 1px solid white;
        margin: 5px 0px;
        border-radius: 5px;
        text-align: center;
    }

    /*.app-info .info-title {
        border-radius: .25em;
        background-color: #5cb85c;
        font-size: 75%;
        font-weight: 700;
        padding: .1em .6em .1em;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        display: inline;
    }*/

    .app-info-detail .content-wrapper {
        border: 1px solid lightgray;
        font-size: 12px;
    }

    .app-info-detail .title {
        height: 30px;
        background-color: #49a2f5;
        color: #FFFFFF;
        font-weight: 400;
        line-height: 30px;
        white-space: nowrap;
        overflow: auto;
    }

    .app-info-detail .content {
        height: 120px;
        background-color: #FFFFFF;
        position: relative;
    }

    .app-info-detail .content p {
        margin: 1px;
    }

    .app-info {
        margin: 2px;
        white-space: nowrap;
    }

    .button-btn {
        cursor: pointer;
        padding: 10px;
        border: 1px solid white;
        margin: 5px 0px;
        border-radius: 5px;
        text-align: center;
    }

    .info-hand {
        padding-bottom: 10px;
        border: 1px solid white;
        margin: 5px 0px;
        border-radius: 5px;
        text-align: center;
        overflow: hidden;
    }

    .infoblanket {
        position: relative;
        padding: 10px;
        border: 1px solid white;
        margin: 5px 0px;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }

    .test-link {
        width: 68px;
        height: 68px;
        padding: 5px;
        background: rgba(30, 29, 39, 0.18);
        border-radius: 50px;
        text-align: center;
        padding-top: calc(50px - 1.4em);
    }

    .demo2 {
        transform-origin: center;
        transform: rotate(-90deg);
    }

    .mask {
        width: 110px;
        height: 110px;
        border-radius: 50%;
        left: 10px;
        top: 10px;
        position: absolute;
        text-align: center;
        line-height: 110px;
        font-size: 16px;
    }

    .fade-enter-active,
    .fade-leave-active {
        transition: opacity .5s
    }

    .fade-enter,
    .fade-leave-active {
        opacity: 0
    }

    .container {
        width: 100%;
        margin: 0 auto;
        padding: 0;
    }

    .bar-unfill {
        height: 30px;
        display: block;
        background: #fff;
        width: 100%;
    }

    .bar-fill {
        height: 30px;
        display: block;
        width: 0;
        background: #5cb85c;
        transition: width .8s ease;
    }

    /* Standard syntax */

    @keyframes progressbar {
        from {
            width: 10%
        }
        to {
            width: 100%
        }
    }

    .slide-fade-enter-active {
        transition: sliding-vertically .3s ease;
    }

    .slide-fade-leave-active {
        transition: sliding-vertically .8s cubic-bezier(1.0, 0.5, 0.8, 1.0);
    }

    .slide-fade-enter,
    .slide-fade-leave-active {
        transform: translateX(10px);
        opacity: 0;
    }

    #lishi {
        border-left: 2px solid #49a2f5;
        background: rgba(30, 29, 39, 0.18);
    }

    #lishi a {
        background-image: url("/static/img/lishi-xuanze.png");
    }
</style>
{% endblock %}

{% block contentright %}
<div class="hw-overlay" id="hw-layer">
    <div class="hw-layer-wrap" style="background:#5cb85c;border: 1px solid white;overflow: auto;opacity: 0.8">
        <div class="row">
            <div class="col-md-3 col-sm-12">
                <p><b>And</b>Cloud</p>
                <p>Static Options</p>
            </div>
            <div class="col-md-9 col-sm-12">
                <div>
                    <h4>选择</h4>
                </div>
                <div style="margin:20px 0 20px;color:black">
                    <form>
                        <select name="version" id="version">
                            {% for item in mirrorlist %}
                            <option value="{{item.id}}">{{item.name}}</option>
                            {% endfor %}
                        </select>
                        <label for="version" style="color: white;font-weight: 100">Version</label>
                        <br/>
                        <select name="time" id="time">
                            <option value="5">5 mins</option>
                            <option value="10">10 mins</option>
                            <option value="15">15 mins</option>
                            <option value="120">2 hours</option>
                        </select>
                        <label for="time" style="color: white;font-weight: 100">Time</label>
                        <br/>
                    </form>
                </div>
                <div style="overflow: hidden">
                    <span style="float:left" class="button-btn confirm">确 定</span>
                    <span style="margin-left:5px;float:left" class="button-btn cancel">取 消</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="app" style="opacity: 0">
    <div class="history-list">
        <!--<div class="history-header" style="z-index: 2">
            <h1 style="font-weight:100;padding-left: 10px">历史列表
                <transition name="bounce">
                    <p style="float:right" v-if="isLoading">Loading...</p>
                </transition>
            </h1>
        </div>-->
        <div class="app">
            <div class="app-wrapper">
                <p style="font-weight: 400;font-size: 12px">已检测项目 <img src="/static/img/xiaosanjiao.png" alt=""></p>
                <div class="app-item-wrapper">
                    <template v-for="app,index in apps">
                        <div class="app-item"
                             :key="index" :data-index="index">
                            <img :src="app.logo" alt="" class="logo">
                            <div style="flex-grow: 2;padding-left: 30px">
                                <div>
                                    <span>应用名称：</span> <span> {$app.label$}</span>
                                </div>
                                <div>
                                    <span>检测日期：</span> <span> {$displayTime(app.created_time)$}</span>
                                </div>
                            </div>
                            <div class="detail-info" @click="select(index)">查看详情</div>
                        </div>
                    </template>
                </div>
                <div class="pagination">
                    <span @click="getData(currentPage - 1)"><img src="/static/img/backward.png" alt=""></span>
                    <span :class="{active: n==currentPage}" v-for="n in pageCount"
                          v-if="(n-currentPage) >= -2 && (n-currentPage) <= 2" @click="getData(n)">{$ n $}</span>
                    <span @click="getData(currentPage + 1)"><img src="/static/img/forward.png" alt=""></span>
                </div>
            </div>
        </div>
    </div>

    <div class="app-selected">
        <div v-if="selectedIndex > -1" v-bind:key="2">
            <div class="test-result-title">
                <p style="font-weight: 400; font-size: 12px">检测结果<span style="color: #49a2f5"> / DETECTION RESULT</span>
                </p>
            </div>
            <div class="app-info-detail">
                <div class="row">
                    <div class="col-xs-3">
                        <div class="content-wrapper">
                            <div class="title" style="text-align: center">应用名称：{$ apps[selectedIndex].label $}</div>
                            <div class="content">
                                <img :src="apps[selectedIndex].logo" alt="" class="logo">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-9">
                        <div class="content-wrapper">
                            <div class="title"
                                 style="padding-left: 15px;display: flex;justify-content: space-between;align-items: center">
                                文件分析报告 <a v-if="apps[selectedIndex].isfullinfo"
                                          style="text-decoration: none;color: #FFFFFF;border-left: 1px solid #FFFFFF;padding-left: 5px;padding-right: 5px;background-color: #49a2f3"
                                          v-bind:href="'/staticreport/index?id=' + apps[selectedIndex].id"
                                          target="view_window"><img
                                    src="/static/img/baogao.png" style="width: 10.8px;height: 12px;vertical-align: -5%"
                                    alt=""> 静态检测报告</a></div>
                            <div class="content" style="padding: 23px 15px;font-size: 10px;font-weight: 400">
                                <div v-if="!apps[selectedIndex].isfullinfo">正在检测，请稍后......</div>
                                <div v-if="apps[selectedIndex].isfullinfo">
                                    <p>包名：{$ apps[selectedIndex].packagename $}</p>
                                    <p>文件大小：{$(apps[selectedIndex].size/ 1024 / 1024).toFixed(2)$}MB</p>
                                    <p>文件MD5： {$apps[selectedIndex].md5$}</p>
                                    <p>文件SHA1：{$apps[selectedIndex].sha1$}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--Waiting for implement-->
            <div class="app-action-list">
                <div class="row">
                    <div v-if="apps[selectedIndex].isfullinfo === false">
                    </div>
                    <div v-else style="overflow: auto;padding: 12px;">
                        <div style="overflow: auto;margin: 15px auto;">
                            <div style="color:white;text-decoration: none;font-weight: 100;font-size: 1.5em;">
                                自动检测
                            </div>
                        </div>


                        <div class="infoblanket">
                            <div class='process_bar' style="width: 30%;">
                                <svg xmlns="http://www.w3.org/200/svg" height="110" width="110">
                                    <circle cx="55" cy="55" r="50" fill="none" stroke="white" stroke-width="5"
                                            stroke-linecap="round"/>
                                    <circle class="demo2" id="J_progress_bar" cx="55" cy="55" r="50" fill="none"
                                            stroke="#5cb85c" stroke-width="5" stroke-dasharray="157,10000"/>
                                </svg>
                                <div class="mask">{$autoPercentage$}</div>
                            </div>

                            <div class="test_info" style="width: 40%;text-align: center">
                                <p>{$ autoToken.imageid $}</p>
                                <p>存活时间：{$ autoToken.testTime $} min</p>
                            </div>

                            <div class="choose_button" style="width: 30%;text-align: center">
                                <p>
                                    <a v-bind:href="'/runner/token/'+autoToken.token"
                                       style="cursor: pointer;color:white;text-decoration: none;font-weight: 100;font-size: 1.5em;margin-right:2%;text-align:right;">
                                        <i class="iconfont icon-creative test-link"
                                           style="font-size: 30px;padding-top:5px;"></i></a>
                                </p>
                                <transition name="fade">
                                    <p v-if='autoToken.isComplete' style="">

                                        <a v-bind:href="'/dynamicreport/index?dynamicid=' + autoToken.simulatorId+'&staticid='+apps[selectedIndex].id+'&auto=1'+'&projectid='+autoToken.projectid"
                                           target="view_window"
                                           style="cursor: pointer;color:white;text-decoration: none;font-weight: 100;font-size: 1.5em;margin-right:2%;text-align:right;">
                                            <i class="iconfont icon-file test-link"
                                               style="font-size: 30px;padding-top:5px;"></i></a>
                                    </p>
                                </transition>
                            </div>
                        </div>


                        <div style="overflow: auto;margin: 15px auto; display: flex; justify-content: space-between;align-items: center">
                            <div style="color:white;text-decoration: none;font-weight: 100;font-size: 1.5em;">
                                手动检测
                            </div>
                            <div v-on:click="chooseTest" data-show-layer="hw-layer"
                                 style="cursor: pointer;color:white;text-decoration: none;font-weight: 100;font-size: 1.5em;">
                                <i class="iconfont icon-repairfill test-link"
                                   style="font-size: 30px;padding-top:5px;"></i>
                            </div>

                        </div>

                        <div id="options">
                            <div class="info-hand" style="margin-bottom: 20px;cursor: auto;"
                                 v-for="(token,index) of handToken" :key="token">
                                <div class="container">
                                    <div class="bar">
                                            <span class="bar-unfill">
                                                <span class="bar-fill" style="position: relative">
                                                    <span class="bar-percentage"
                                                          style="position: absolute;top:50%;left: 50%;transform: translate(-50%, -50%);"></span>
                                            </span>
                                            </span>
                                    </div>
                                </div>
                                <div class="test_info"
                                     style="width:100%;text-align: center;margin: 0 auto;padding: 10px">
                                    <p>{$ token.imageid $}</p>
                                    <p>存活时间：{$ token.testTime $} min</p>
                                </div>
                                <a :href="'/runner/token/'+token.token"
                                   style="color:white;text-decoration: none;font-weight: 100;font-size: 1.5em"><i
                                        class="iconfont icon-creative test-link"
                                        style="font-size: 30px;padding-top:5px;"></i></a>
                                <a v-on:click="terminateHandTest(token)" v-if="!(token.isComplete)"
                                   style="color:white;text-decoration: none;font-weight: 100;font-size: 1.5em;cursor: pointer"><i
                                        class="iconfont icon-stop test-link"
                                        style="font-size: 30px;padding-top:5px;"></i></a>

                                <a v-bind:href="'/dynamicreport/index?dynamicid=' + token.simulatorId+'&staticid='+apps[selectedIndex].id+'&auto=0'+'&projectid='+token.projectid"
                                   target="view_window" v-if="token.isComplete"
                                   style="color:white;text-decoration: none;font-weight: 100;font-size: 1.5em;cursor: pointer"><i
                                        class="iconfont icon-file test-link"
                                        style="font-size: 30px;padding-top:5px;"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</div>
{% endblock %}

{% block js %}
<script>
    if (location.hash === '') {
        location.hash = '1#0';
    }
    let storeHash = location.hash.split('#').splice(1);
    if (storeHash.length !== 2) {
        location.hash = '1#0';
        storeHash = location.hash.split('#').splice(1);
    } else {
        if (isNumber(storeHash[0])) {
            storeHash[0] = parseInt(storeHash[0]);
        } else {
            storeHash[0] = 1;
        }
        if (isNumber(storeHash[1])) {
            storeHash[1] = parseInt(storeHash[1]);
            if (storeHash[1] >= 9 || storeHash[1] < 0) {
                storeHash[1] = 0;
            }
        } else {
            storeHash[1] = 0;
        }
    }


    let lastPage = storeHash[0],
        lastIndex = storeHash[1];

    function isNumber(obj) {
        return !isNaN(parseFloat(obj)) && isFinite(obj);
    }

    $('.guide-bar p')[0].firstChild.nodeValue = '历史记录';
    $('.guide-bar p')[0].childNodes[1].firstChild.nodeValue = ' / HISTORICAL RECORD';
    var formatDate = function (date) {
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? '0' + m : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        return y + '-' + m + '-' + d;
    };
    //展示层


    function showLayer(id) {
        var layer = $('#' + id),
            layerwrap = layer.find('.hw-layer-wrap');
        layer.slideToggle();
        //屏幕居中
        layerwrap.css({
            'margin-top': -layerwrap.outerHeight() / 2
        });
    }

    //隐藏层
    function hideLayer() {
        $('.hw-overlay').slideToggle();
    }

    $('.confirm').on('click', function () {
        hideLayer();
        let projectid = $vm.apps[$vm.selectedIndex].id;
        let type = 0;
        let tokens = $vm.appTokens[projectid];
        for (var token of tokens) {
            if (token.type > type) {
                type = token.type;
            }
        }
        type++;
        let formData = new FormData();
        formData.append('type', type);
        formData.append('projectid', projectid);
        formData.append('vm', $('#version').val());
        formData.append('time', $('#time').val());
        $.ajax({
            url: '/project/uploadhandful',
            data: formData,
            method: 'POST',
            contentType: false,
            processData: false,
            success: data => {
                let token = data.data;
                $vm.handToken.push(token);
                $vm.appTokens[projectid][type] = token;
                $vm.handleHandToken();
            }
        })
    });
    $('.cancel').on('click', function () {
        hideLayer();
    });

    //点击或者触控弹出层外的半透明遮罩层，关闭弹出层
    $('.hw-overlay').on('click', function (event) {
        if (event.target == this) {
            hideLayer();
        }
    });

    //按ESC键关闭弹出层
    $(document).keyup(function (event) {
        if (event.keyCode == 27) {
            hideLayer();
        }
    });
</script>
<script src="/static/app/js/velocity.min.js"></script>
<script src="/static/app/js/moment-with-locales.js"></script>
<script>
    moment.locale('zh-CN');
    Vue.config.debug = true;
    Vue.config.silent = false;


    var $vm = new Vue({
        el: '#app',
        delimiters: ['{$', '$}'],
        data: {
            isLoading: true,
            selectedIndex: -1,
            apps: [],
            appTokens: {},
            autoToken: {},
            handToken: [],
            items: [1],
            autoPercentage: 0,
            autoComplete: false,
            autoInterval: undefined,
            handInterval: undefined,
            timeGap: 0,
            pageCount: '',
            currentPage: ''
        },
        methods: {
            getTokensEvt: function (projectid) {
                this.getTokens(projectid, (tokens) => {
                    this.autoToken = tokens[0];
                    this.handToken = tokens.slice(1);
                    //autoToken数据处理&&动画控制
                    if (this.autoInterval) {
                        clearInterval(this.autoInterval);
                    }
                    $.ajax({
                        url: "/project/getLifeCycle",
                        data: {
                            projectid: this.autoToken.projectid,
                            type: this.autoToken.type
                        },
                        method: "GET",
                        success: data => {
                            if (data.errno === 0) {
                                let simulator = data.data[0];
                                let createTime = Date.parse(simulator.createtime);
                                let deadlineTime = Date.parse(simulator.deadlinetime);
                                let totalTime = deadlineTime - createTime;
                                Vue.set($vm.autoToken, 'testTime', (totalTime / 1000 / 60).toFixed(2));
                                Vue.set($vm.autoToken, 'simulatorId', simulator.id);
                                if ((deadlineTime - (new Date().getTime() + this.timeGap)) > 0) {
                                    Vue.set($vm.autoToken, 'isComplete', false);
                                } else {
                                    Vue.set($vm.autoToken, 'isComplete', true);
                                }
                                let nowTime;
                                let circle = $('#J_progress_bar');
                                let circleLength = Math.floor(2 * Math.PI * circle.attr('r'));

                                this.autoInterval = setInterval(() => {
                                    nowTime = new Date().getTime() + this.timeGap;
                                    let val = nowTime - createTime;
                                    val = Math.max(0, val);
                                    val = Math.min(totalTime, val);
                                    let percentage = Math.round((val / totalTime) * 100);
                                    if (percentage !== 100) {
                                        $vm.autoPercentage = Math.round((val / totalTime) * 100) + '%';
                                    } else {
                                        $vm.autoPercentage = '检测完成';
                                    }
                                    circle.attr('stroke-dasharray', "" + circleLength * (val / totalTime) + ', 10000');
                                    circle.attr('stroke', '#5cb85c');
                                    if (val === totalTime) {
                                        $vm.autoComplete = true;
                                        clearInterval(this.autoInterval);
                                        Vue.set($vm.autoToken, 'isComplete', true);
                                    }
                                }, 100);
                            } else {
                                $vm.autoPercentage = "无检测数据";
                                let circle = $('#J_progress_bar');
                                let circleLength = Math.floor(2 * Math.PI * circle.attr('r'));
                                circle.attr('stroke-dasharray', "" + circleLength + ', 10000');
                                circle.attr('stroke', 'red');
                            }
                        }
                    });

                    //handToken数据处理&&动画控制
                    this.handleHandToken();
                });
            },
            getTokens: function (projectid, success_callback) {
                if (this.appTokens[projectid] !== undefined) {
                    return success_callback(this.appTokens[projectid]);
                }
                $.ajax({
                    url: '/project/getTokens',
                    data: {
                        projectid: projectid
                    },
                    method: "POST",
                    success: data => {
                        if (data.errno !== 0) {
                            return alert(data.errmsg);
                        }
                        data.data.forEach($ => {
                            var projectid = $.projectid;
                            if (this.appTokens[projectid] === undefined) {
                                this.appTokens[projectid] = [];
                            }
                            this.appTokens[projectid][$.type] = $;
                        });
                        success_callback(this.appTokens[projectid]);
                    }
                });
            },
            handleHandToken: function () {
                setInterval(() => {
                    for (let token of this.handToken) {
                        let nowTime = new Date().getTime() + this.timeGap;
                        let val = nowTime - token.createTime;
                        val = Math.max(0, val);
                        val = Math.min(token.totalTime, val);
                        let percentage = Math.round((val / token.totalTime) * 100);
                        if (token.isSet === false) {
                            token.isSet = true;
                            let leftTime = Math.round((token.totalTime - val) / 1000);
                            /*let keyframe = findKeyframesRule('progressbar');
                             keyframe.deleteRule('0%');
                             keyframe.appendRule('0% { width: ' + percentage + '%; }');*/
                            if (leftTime !== 0) {
                                token.barFill.style.animation = 'progressbar ' + leftTime + 's 1 forwards';
                            } else {
                                token.barFill.style.animation = 'progressbar 0.5s 1 forwards';

                            }
                        }

                        if (val !== token.totalTime) {
                            token.barPercentage.innerHTML = percentage + '%';
                        } else {
                            token.barPercentage.innerHTML = '✌️';
                            Vue.set(token, 'isComplete', true);
                        }
                    }
                }, 100);
                setTimeout(() => {
                    for (let i = 0; i < this.handToken.length; i++) {
                        $.ajax({
                            url: "/project/getLifeCycle",
                            data: {
                                projectid: this.handToken[i].projectid,
                                type: this.handToken[i].type
                            },
                            method: "GET",
                            success: data => {
                                if (data.errno === 0) {
                                    let simulator = data.data[0];
                                    let createTime = Date.parse(simulator.createtime);
                                    let deadlineTime = Date.parse(simulator.deadlinetime);
                                    let totalTime = deadlineTime - createTime;
                                    let barFill = $('.bar-fill')[i];
                                    let barPercentage = $('.bar-percentage')[i];

                                    Vue.set($vm.handToken[i], 'testTime', (totalTime / 1000 / 60).toFixed(2));
                                    Vue.set($vm.handToken[i], 'totalTime', totalTime);
                                    Vue.set($vm.handToken[i], 'createTime', createTime);
                                    Vue.set($vm.handToken[i], 'deadlineTime', deadlineTime);
                                    Vue.set($vm.handToken[i], 'simulatorId', simulator.id);
                                    if (($vm.handToken[i].deadlineTime - (new Date().getTime() + this.timeGap)) > 0) {
                                        Vue.set($vm.handToken[i], 'isComplete', false);
                                    } else {
                                        Vue.set($vm.handToken[i], 'isComplete', true);
                                    }
                                    Vue.set($vm.handToken[i], 'barFill', barFill);
                                    Vue.set($vm.handToken[i], 'barPercentage', barPercentage);
                                    Vue.set($vm.handToken[i], 'isSet', false);
                                }
                            }
                        })
                    }
                }, 800)
            },
            getApkInfo: function (projid) {
                $.ajax({
                    url: '/project/apkinfo',
                    data: {
                        proj: projid
                    },
                    method: "GET",
                    success: data => {
                        var apkinfo = null;
                        if (!data.data || data.data.length == 0) {
                            console.log("projid" + projid + " not have apkinfo");
                            return;
                        }
                        apkinfo = data.data[0];
                        this.apps.forEach(function ($) {
                            if ($.id === projid) {
                                if (apkinfo.id) {
                                    $.isfullinfo = true;
                                    for (var key in apkinfo) {
                                        if (key == 'id') continue;
                                        if (apkinfo.hasOwnProperty(key)) {
                                            $[key] = apkinfo[key];
                                        }
                                    }
                                } else {
                                    $.isfullinfo = false;
                                }
                            }
                        })
                    }
                });
            },
            select: function (index) {
                this.selectedIndex = index;
                this.getTokensEvt(this.apps[this.selectedIndex].id);
                this.getApkInfo(this.apps[this.selectedIndex].id);
                setTimeout(function () {
                    for (let item of $('.app-item')) {
                        item.style.border = '1px solid lightgray';
                        item.childNodes[4].style.backgroundColor = '#ffffff';
                        item.childNodes[4].style.color = '#49a2f5';
                    }
                    $('.app-item')[index].style.border = '1px solid #49a2f5';
                    $('.app-item')[index].childNodes[4].style.backgroundColor = '#49a2f5';
                    $('.app-item')[index].childNodes[4].style.color = '#ffffff';
                }, 100)
                location.hash = `${this.currentPage}#${this.selectedIndex}`;
            },
            displayTime: function (time) {
                return moment(time, 'YYYY-MM-DD HH:mm:ss').fromNow()
            },
            beforeEnter: function (el, done) {
                el.style.opacity = 0;
                var len = el.dataset.index * 50;
                $.Velocity(el, {
                    translateY: len + "px"
                }, {
                    complete: done
                });
                //                el.style.height = 0;
            },
            enter: function (el, done) {
                var delay;
                if (el.dataset.index > 10) {
                    delay = 500;
                } else {
                    delay = el.dataset.index * 50;
                }
                setTimeout(function () {
                    $.Velocity(
                        el, {
                            opacity: 1,
                            translateY: "0px"
                        }, {
                            complete: done
                        }
                    )
                }, delay)
            },
            leave: function (el, done) {
                var delay = el.dataset.index * 150;
                setTimeout(function () {
                    $.Velocity(
                        el, {
                            opacity: 0,
                            translateY: "200px"
                        }, {
                            complete: done
                        }
                    )
                }, delay)
            },
            chooseTest: function () {
                var layerid = 'hw-layer';
                showLayer(layerid);
            },
            terminateHandTest: function (token) {
                $.ajax({
                    url: "/project/updateLifeCycle",
                    data: {
                        projectid: token.projectid,
                        type: token.type
                    },
                    method: "POST",
                    success: (data) => {
                        if (data.errno === 0) {
                            $vm.handleHandToken();
                            token.barFill.style.animation = 'progressbar 0.5s 1 forwards';
                        }
                    }
                })
            },
            getNow: function () {
                $.ajax({
                    url: "/project/getNow",
                    method: "GET",
                    success: (data) => {
                        let serverTime = data.data;
                        let localTime = new Date().getTime();
                        this.timeGap = serverTime - localTime;
                    }
                });

            },
            getData: function (n) {
                if (n > this.pageCount || n < 1) {
                    return;
                }
                $.ajax({
                    url: "/project/getlist",
                    data: {
                        perPage: 9,
                        getPage: n
                    },
                    success: data => {
                        if (data.errno == 0) {
                            var apps = data.data.data;
                            $vm.pageCount = data.data.totalPages;
                            $vm.currentPage = data.data.currentPage;
                            $vm.getNow();
                            setTimeout(() => {
                                $vm.isLoading = false;
                                $vm.apps = apps.map(function (app) {
                                    app.created_time = app.uploadtime;
                                    app.isfullinfo = false;
                                    if (!app.label) {
                                        app.label = "正在检测...";
                                    }
                                    if (!app.logo) {
                                        app.logo = "/static/images/loading.gif";
                                    }
                                    return app;
                                });
                                this.selectedIndex = 0;
                                this.select(this.selectedIndex);

                            }, 100);
                        }
                    }
                });

                for (let item of $('.app-item')) {
                    item.style.border = '1px solid lightgray';
                    item.childNodes[4].style.backgroundColor = '#ffffff';
                    item.childNodes[4].style.color = '#49a2f5';
                }
            }
        },
        mounted: function () {
            $(this.$el).css('opacity', '1')
        }
    });
    function getList() {
        $.ajax({
            url: "/project/getlist",
            data: {
                perPage: 9,
                getPage: lastPage
            },
            success: data => {

                if (data.errno == 0) {
                    var apps = data.data.data;
                    $vm.pageCount = data.data.totalPages;
                    $vm.currentPage = data.data.currentPage;
                    $vm.getNow();
                    if (lastPage > $vm.pageCount || lastPage < 1) {
                        lastPage = 1;
                        if ($vm.pageCount !== 0) {
                            getList();
                        }
                        return;
                    }
                    setTimeout(() => {
                        $vm.isLoading = false;
                        $vm.apps = apps.map(function (app) {
                            app.created_time = app.uploadtime;
                            app.isfullinfo = false;
                            if (!app.label) {
                                app.label = "正在检测...";
                            }
                            if (!app.logo) {
                                app.logo = "/static/images/loading.gif";
                            }
                            return app;
                        });
                        $vm.selectedIndex = lastIndex;
                        $vm.select($vm.selectedIndex);
                    }, 100);
                }
            }
        });
    }
    getList();

</script>
{% endblock %}