{% extends "./../basebar.html" %}
{% block headerbar %}
<style>
    .info_an {
        transition: all 100ms ease;
    }

    .wave_position {
        transition: all 1000ms ease;
        height: 166px;
        position: relative;
        bottom: 165px;
        /* width: 100%; */
        left: 0;
        width: 4592px;
    }
    #file_drag{
        /*background: repeating-linear-gradient(-45deg, rgba(13, 21, 56, 0.36), rgba(13, 21, 56, 0.36) 5px, transparent 5px, transparent 10px);*/

    }
    @keyframes background-move {
        0%{
            box-shadow: black 0px 0px 50px;
        }
        50%{
            box-shadow: black 0px 0px 0px;
        }
        100%{
            box-shadow: black 0px 0px 50px;
        }
    }
</style>
{% endblock %}
{% block contentright %}
<!--<div style="width:100%;height:80px;background: rgba(13, 21, 56, 0.36)">-->

<!--</div>-->
<div id="file_drag" class=""
     style="height: calc(100% - 80px); margin: 40px;border:dotted rgba(13, 21, 56, 0.36) 3px;text-align: center;overflow: hidden">

    <div class="info_an" id="message" style="position: relative;top: 50%; margin-top: -0.5em">拖拽到此上传 &nbsp;OR&nbsp; 点击这个框</div>
    <input type="file" style="width: 100%;height: 100%;outline:none;cursor:pointer;margin-top: -1em;opacity: 0"
           id="file">
    <div class="wave wave_position" style="bottom:0px"></div>
    <div class="wave_position" style="background: rgba(13, 21, 56, 0.36);height:1000px;bottom:0px"></div>
</div>
{% endblock %}
{% block js %}
<script>
    function uploadFile(file){

        var name = file.name;
        var size = file.size;
        var formData = new FormData();
        formData.append('apk', file);
        formData.append('name', 'test');
        $.ajax({
            url: '/project/upload',
            data: formData,
            method: 'POST',
            contentType: false,
            processData: false,
            xhr: function(){        //这是关键  获取原生的xhr对象  做以前做的所有事情
                var xhr = jQuery.ajaxSettings.xhr();
                xhr.upload.onload = function (){

                };
                xhr.upload.onprogress = function (ev) {
                    if(ev.lengthComputable) {
                        var percent = new Intl.NumberFormat('en-IN', { maximumSignificantDigits: 2 }).format(100 * ev.loaded/ev.total);
                        console.log(percent,ev);
                        message("上传 <i>"+ name + "</i> " +percent+"%");
                        updateProgress(percent+"%");
                    }
                };
                return xhr;
            },
            success: function (data) {
                hide();
                message("上传 <i>"+ name +"</i> 成功");
            }
        });
    }

    $("#file").on('change', function (evt) {
        var file = this.files[0];
        uploadFile(file);
    });

    function message(message,status){
        $("#message").html(message);
        switch(status){
            case "success":
                $("#message").css('color','green');
                setTimeout(function(){
                    $("#message").css('color','white');
                },3000);
                break;
            case "failed":
                $("#message").css('color','red');
                break;
            case "normal":
                $("#message").css('color','white');
                break;
            default:
        }
        $("#message").css('color')
    }

    function show(){
        updateProgress("0%");
    }
    function hide(){
        updateProgress("-166px");
    }
    function updateProgress(precent) {
        $(".wave_position").each(function (ele) {
            var data = $(this).css('bottom');
            var num = parseInt(data.substr(0, data.length - 2), 10);
            num += 20;
            $(this).css('bottom', "calc("+ precent +" + 166px)");
        });
    }
    var isOver = false;
    $("body").get(0).ondragleave = function(evt){
        console.log("drag leave");
        $('#file_drag').css('animation','none');
        isOver = false;
        return false;
    };
    $("body").get(0).ondragover = function(evt){
        console.log("drag enter");
        evt.preventDefault();
        if(!isOver) {
            $('#file_drag').css('animation', 'background-move 2000ms ease infinite');
            isOver = true;
        }
    };

    $('#file_drag').get(0).addEventListener('drop', function (e) {
        console.log(e);
        e.preventDefault(); // 阻止默认事件
        isOver = false;
        $('#file_drag').css('animation','none');
        var file = e.dataTransfer.files[0]; //获取文件
        uploadFile(file);
    }, false);

</script>
{% endblock %}