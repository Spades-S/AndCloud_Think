{% extends "./../basebar.html" %}{% block headerbar %}
<style>
    body {
        min-width: 1000px;
    }
    
    .right-content {
        overflow: auto;
        position: relative;
    }
    
    .screen-container {
        width: 500px;
        height: 100%;
        position: absolute;
        min-height: 700px;
    }
    
    .phone-shell {
        position: absolute;
        top: 50%;
        left: 50%;
        margin-left: -150px;
        margin-top: -290px;
        width: 300px;
        height: 578px;
        background: url(/static/img/phone-shell.png);
        background-size: 300px 578px;
        background-repeat: no-repeat;
        padding: 70px 20px 71px 20px;
    }
    
    #phone-screen {
        /*border: 1px solid #cccccc;
        position: absolute;
        top: 50%;
        left: 50%;
        margin-left: -180px;
        margin-top: -290px;*/
        background-color: #181818;
    }
    
    .log-container {
        position: absolute;
        top: 0;
        bottom: 0;
        right: 0;
        left: 500px;
        min-height: 700px;
        padding: 15px;
    }
    
    .log-title {
        height: 50px;
        background-color: rgba(41, 40, 40, 0.28);
        font-size: 17px;
        font-weight: 400;
        padding-top: 12px;
        padding-left: 20px;
        margin-bottom: 3px;
        color: #ffffff;
        font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
    }
    
    pre {
        height: calc(100% - 53px);
        background-color: rgba(14, 14, 14, 0.14);
        border: none;
        border-radius: 5px;
        border-top-left-radius: 0px;
        border-top-right-radius: 0px;
        color: white;
    }
</style>
{% endblock %} {% block contentright %}
<div class="screen-container" id="screen-container">
    <div class="phone-shell">
        <canvas id="phone-screen"></canvas>
    </div>

</div>
<div id="app" class="log-container">
    <div class="log-title">
        <p>检测日志</p>
    </div>
    <pre>{$logList.join('\n')$}</pre>
</div>
{% endblock %}{% block js %}
<script src="/static/socket/socket.io.js"></script>
<script>
    var $vm = new Vue({
        el: '#app',
        delimiters: ['{$', '$}'],
        data: {
            logList: [],
        },
        methods: {
            addLog: function($log) {
                while (this.logList.length > 1000) {
                    this.logList.shift();
                }
                this.logList.push($log);
            }
        }
    });
    let socket = new WebSocket('ws://192.168.8.88:6565');
    let imgsocket = new WebSocket('ws://192.168.8.88:6566');
    let canvas = document.getElementById('phone-screen');
    var pinger = null;
    socket.onopen = function() {
        socket.send(JSON.stringify({
            type: 'auth',
            detail: '{{token}}'
        }));
        pinger = setInterval(function() {
            socket.send(JSON.stringify({
                type: 'ping',
                detail: '{{token}}'
            }))
        }, 1000 * 30);
    };
    socket.onmessage = function(message) {
        if (message) {
            var msg = message.data;
            if (msg == "{type:\"pong\"}") {
                return;
            } else {
                $vm.addLog(msg);
            }
            // console.log(msg);
        }
    };
    socket.onclose = function() {
        clearInterval(pinger)
    };
    (function() {
        var BLANK_IMG =
            'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='
        var canvas = document.getElementById('phone-screen');
        var ctx = canvas.getContext('2d');
        canvas.width = 260;
        canvas.height = 435;
        var pinger = null;
        imgsocket.onopen = function() {
            imgsocket.send(JSON.stringify({
                type: 'auth',
                detail: '{{token}}'
            }));
            pinger = setInterval(function() {
                imgsocket.send(JSON.stringify({
                    type: 'ping',
                    detail: '{{token}}'
                }))
            }, 1000 * 30);
            canvas.addEventListener('mousedown', mouseDownListener);
        };
        imgsocket.onmessage = function(message) {
            var msg = message.data;
            if (msg == "{type:\"pong\"}") {
                return;
            } else {
                var blob = new Blob([msg], {
                    type: 'image/jpeg'
                });
                var URL = window.URL || window.webkitURL;
                var img = new Image();
                img.onload = function() {
                    let width = (Number('{{height}}') / Number('{{wmheight}}')) * (Number('{{wmwidth}}'));
                    ctx.drawImage(img, (Number('{{width}}') - width) / 2, 0, width, '{{height}}', 0, 0, canvas.width, canvas.height);
                    img.onload = null;
                    img.src = BLANK_IMG;
                    img = null;
                    u = null;
                    blob = null;
                };
                var u = URL.createObjectURL(blob);
                img.src = u
            }
        }
        imgsocket.onclose = function() {
            clearInterval(pinger)
        }
    })();

    function dataLimit(data) {
        if (data < 0) {
            data = 0;
        } else if (data > 1) {
            data = 1;
        }
        return data;
    }

    function calculateRate(event) {
        let controlData = {
            MODE: 'DOWN',
            X: 0,
            Y: 0
        };
        let offsetY = (document.getElementById('screen-container').offsetHeight - canvas.height) / 2;
        let offsetX = canvas.offsetLeft + 320;
        controlData.X = dataLimit((event.pageX - offsetX) / canvas.width);
        controlData.Y = dataLimit((event.pageY + document.getElementById('right-content').scrollTop - offsetY) / canvas.height);
        return controlData;
    }

    function mouseDownListener(event) {
        if (event.which == 3) {
            return;
        }
        event.preventDefault();
        let Data = calculateRate(event);
        let sendData = {
                type: 'touch',
                detail: Data.MODE + ',' + Data.X + ',' + Data.Y
            }
            // console.log(JSON.stringify(sendData));
        imgsocket.send(JSON.stringify(sendData));
        canvas.addEventListener('mousemove', mouseMoveListener);
        canvas.addEventListener('mouseup', mouseUpListener);
        canvas.addEventListener('mouseleave', mouseUpListener);
    }

    function mouseMoveListener(event) {
        if (event.which == 3) {
            return;
        }
        let Data = calculateRate(event);
        event.preventDefault();
        Data.MODE = 'MOVE';
        let sendData = {
                type: 'touch',
                detail: Data.MODE + ',' + Data.X + ',' + Data.Y
            }
            // console.log(JSON.stringify(sendData));
        imgsocket.send(JSON.stringify(sendData));
    }

    function mouseUpListener(event) {
        if (event.which == 3) {
            return;
        }
        event.preventDefault();
        let Data = calculateRate(event);
        Data.MODE = 'UP';
        let sendData = {
                type: 'touch',
                detail: Data.MODE + ',' + Data.X + ',' + Data.Y
            }
            // console.log(JSON.stringify(sendData));
        imgsocket.send(JSON.stringify(sendData));
        stopMousing();
    }

    function stopMousing() {
        canvas.removeEventListener('mousemove', mouseMoveListener);
        canvas.removeEventListener('mouseup', mouseUpListener);
        canvas.removeEventListener('mouseleave', mouseUpListener);
    }
</script>
{% endblock %}